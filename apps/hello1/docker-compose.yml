services:
  hello1:
    container_name: hello1-service
    image: nginx:1.27-alpine # Alpine includes wget for healthchecks
    restart: unless-stopped
    env_file: .env

    # üîó Network: Attach to external Traefik proxy
    networks:
      - proxy

    # üîí Security: No host ports exposed.
    # ports:
    #   - "8080:80" # BLOCKED

    # üöÄ Resources: Compose-enforced limits
    mem_limit: 256m
    cpus: 0.5

    # ‚úÖ Health: Works out-of-the-box in Alpine
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:80/ >/dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # üó∫Ô∏è Traefik: Proxy routing & TLS
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.hello1-router.rule=Host(\"hello1.valhallala.com\")"
      - "traefik.http.routers.hello1-router.entrypoints=websecure"
      - "traefik.http.routers.hello1-router.tls=true"
      - "traefik.http.routers.hello1-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hello1-router.service=hello1-service"
      - "traefik.http.routers.hello1-fallback.rule=PathPrefix(\"/\")"
      - "traefik.http.routers.hello1-fallback.entrypoints=websecure"
      - "traefik.http.routers.hello1-fallback.tls=true"
      - "traefik.http.routers.hello1-fallback.service=hello1-service"
      - "traefik.http.routers.hello1-fallback.priority=1"
      - "traefik.http.services.hello1-service.loadbalancer.server.port=80"

    # üíæ Storage: Use named volumes for persistence
    volumes:
      - ./html:/usr/share/nginx/html

networks:
  proxy:
    external: true
